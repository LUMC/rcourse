---
output:
  html_document:
    pandoc_args: ["--metadata-file=_meta/dplyr0.yml"]
---

```{r , include=FALSE}
# source( "R_course_setup.R" );
if (exists("params")) {
  knitr::opts_chunk$set(echo = FALSE, eval = FALSE, comment = NA)
} else  {
  knitr::opts_chunk$set(echo = TRUE, eval = TRUE, comment = NA)
}
pulse <- read.delim( "data/pulse.txt" )
survey <- read.delim( "data/survey.txt" )
```


# `dplyr` : data manipulation

Load `tidyverse`:

```{r warning=FALSE,message=FALSE, echo=TRUE}
library( tidyverse )
```


## General properties of `survey` data {#GeneralProperties}

  
  - Load the survey data in `tibble` format and inspect the meta information such as dimensions and column (variable) types.

```{r}
# The path to survey/pulse may differ in your case.
survey <- read.delim("data/survey.txt") 
survey <- as_tibble( survey )
# alternatively
survey <- read.delim("data/survey.txt")  %>% as_tibble()
survey
```

  - Inspect survey data with functions such as  `class`, `str`, `glimpse` (tidyverse) functions.
      - What is the difference between `str` and `glimpse` output? 


```{r}
class( survey )
str( survey )
glimpse( survey )
```

  - Produce the following values on survey data by using the pipe operator `%>%`:

    - number of rows 
    - number of columns
    - last 8 rows 
    - first 7 rows
    - last 3 column names

```{r}
survey %>% nrow
survey %>% ncol
survey %>% tail(8)
survey %>% head(7)
survey %>% colnames %>%  tail(3)
```

## Selection & Filtering {#SelectAndFilter}

Apply the following to survey data: 

  - Rename the `m.i` variable into `system`
  ```{r}
  survey  <- survey %>% rename(system=m.i)
  # print 'system' first for convenience
  survey %>% select(system,everything()) 
  ```
  - Reorder the variables as such that name,age and gender come first 
  ```{r}
  survey %>% select(name,age,gender,everything())
  ```
  - Select the last three variables
  ```{r}
  survey %>% select( (ncol(survey)-2):ncol(survey)  )  # <=> select(11:13)
  ```
  - Deselect variables that relate to hand and/or arm (e.g. *.hnd, etc.)
  ```{r}
  survey %>% select(-span1,-span2,-hand,-fold,-clap)
  ```

Summary values survey data:

  - Retrieve distinct values for smoking habit (`smokes`), do the same for exercise pattern `exercise`.
  ```{r}
  survey %>% distinct(smokes) 
  survey %>% distinct(exercise) 
  
  ```
  - Derive the frequency (count) table of smoking, do the same for exercise pattern.
  ```{r}
  survey %>% count(smokes)
  survey %>% count(exercise)
  ```
  - Derive the frequency (count) table of smoking and exercise pattern.
  ```{r}
  survey %>% count(exercise, smokes)
  ```
  - How many females are there who never smoked?
  ```{r}
  survey %>% count(gender,smokes) %>%  filter(gender=="female" & smokes=="never")
  ```
  - How many right-handed heavy smokers are there, counts per gender? 
  ```{r}
  survey %>% count(gender,hand, smokes) %>% filter(smokes=="heavy" & hand=="right")
  ```
  - Select teenagers.
  ```{r}
  survey %>% filter(age<20)
  ```
  - What are the counts of smoking habits (`smokes`) in teenagers?
  ```{r}
  survey %>% filter(age<20) %>% count(smokes)
  ```
  - What are the counts of exercise patterns (`exercise`) in teenagers?
  ```{r}
  survey %>% filter(age<20) %>% count(exercise)
  ```

## Add variables {#mutate}

  - Add a new column `feet` with heights reported in feet unit (1 foot = 30.48 cm).  
  ```{r}
  survey <- survey %>% mutate(feet=height/30.48)             
  survey %>% select(feet, everything())
  ```
  - Add a new column 'diffHandSpan' : the absolute difference in span of writing hand `span1` and non-writing hand `span2`.
  ```{r}
  survey <- survey %>% mutate(diffHandSpan=abs(span2-span1))  
  survey %>% select(diffHandSpan,everything()) 
  ```
  - Count the number of students with smaller writing hand span.
  ```{r}
  survey %>% mutate(writingHandSpan=span2-span1) %>%  
                   filter(writingHandSpan>0) %>% 
                   nrow()
  ```


## Calculate summaries and grouping {#CalcSummariesAndGrouping}

**Summary (summarise)**

In survey data summarise on: 

  - mean `age` along with total count
  ```{r}
  survey %>% summarise(count = n(), meanAge = mean( age ) )
  ```
  - mean writing and non-writing hand span (`span1`,`span2`) .
  ```{r}
  survey %>% summarise(count = n(), meanWRspan = mean( span1 ),meanNWspan = mean( span2 ) )
  ```
  - mean, minimum and maximum `feet` (height)
  ```{r}
  # Solutions (a) and (b) in handling the missing values (NA's)
  #
  # (a) Filter out observations with feet values missing
  survey %>%  filter(!is.na(feet)) %>% 
     summarise(maxFeet=max(feet), minFeet=min(feet), averageFeet = mean(feet))
  # (b) Use na.rm =T option to avoid NA's in feet varaible as a result
  survey %>% 
    summarise(maxFeet=max(feet, na.rm = T), minFeet=min(feet, na.rm = T), 
                  averageFeet = mean(feet, na.rm = T))
  ```
  
**Group (group_by)**

1. Summarise on average age separately for each of the following group(s): 

  - gender 
  ```{r}
  survey %>%  group_by(gender) %>% summarise(mean(age))
  ```
  - smoking habit
  ```{r}
  survey %>%  group_by(smokes) %>% summarise(mean(age))
  ```
  - gender and smoking habit
  ```{r}
  survey %>%  group_by(gender,smokes) %>% summarise(mean(age))
  ```
  - exercise pattern
  ```{r}
  survey %>%  group_by(exercise) %>% summarise(mean(age))
  ```
  - gender and exercise pattern
  ```{r}
  survey %>%  group_by(gender,exercise) %>% summarise(mean(age))
  ```


2. Repeat the previous exercise with the addition of a new column with group sizes.

```{r}
survey %>%  group_by(gender) %>% summarise(mean(age),N=n())
survey %>%  group_by(smokes) %>% summarise(mean(age), N=n())
survey %>%  group_by(gender,smokes) %>% summarise(mean(age), N=n())
survey %>%  group_by(exercise) %>% summarise(mean(age), N=n())
survey %>%  group_by(exercise, gender) %>% summarise(mean(age), N=n())
```


**Sort (arrange)**

Order the survey data by:

  - name
  ```{r}
  survey %>%  arrange(name)
  ```
  - gender and name
  ```{r}
  survey %>%  arrange(gender,name)
  ```
  - name and gender
  ```{r}
  survey %>%  arrange(name,gender)
  ```
  - gender,name and smoking habit 
  ```{r}
  survey %>%  arrange(gender,name,smokes)
  ```
  - descending order of gender, name and descending order of height 
  ```{r}
  survey %>%  arrange(desc(gender),name,desc(height))
  ```
  
## Extra exercises {#extra}

1. Calculate the following in the survey data:

  - average `height`
  ```{r}
  survey %>% summarise(avgHeight=mean(height, na.rm = T))
  ```
  - minimum and maximum writing hand span `span1`
  ```{r}
  survey %>% summarise(minSpanWR=min(span1,na.rm = T), maxSpanWR=max(span1,na.rm = T))
  ```
  - minimum and maximum non-writing hand span `span2`
  ```{r}
  survey %>% summarise(minSpanNW=min(span2,na.rm = T), maxSpanNW=max(span2,na.rm = T))
  ```

2. In the survey data some students reported their heights in metric and some in imperial units and afterwards these were converted to metric (cm). Add a new column `reportedHeight` with heights reported by the student in the original unit (`system` or `m.i`). Assume inch in case of imperial (1 inch = 2.54 cm) . Hint: use `ifelse` to test for the `system` used. 

```{r}
# Note that we have renamed the variable 'm.i' to 'system'
survey %>%  mutate(reportedHeight=ifelse(system=="imperial",height/2.54,height)) %>%
    select(height, system, reportedHeight, everything())
  
```


